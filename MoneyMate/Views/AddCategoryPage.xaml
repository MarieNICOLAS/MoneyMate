<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:MoneyMate.Components"
             xmlns:viewmodels="clr-namespace:MoneyMate.ViewModels"
             x:Name="PageRoot"
             x:Class="MoneyMate.Views.AddCategoryPage">

    <!-- ViewModel -->
    <ContentPage.BindingContext>
        <viewmodels:CategoryViewModel />
    </ContentPage.BindingContext>

    <!-- STRUCTURE GLOBALE -->
    <Grid RowDefinitions="Auto,*,Auto"
          BackgroundColor="{StaticResource BackgroundLight}">

        <!-- â­ HEADER -->
        <components:HeaderAuthenticated Grid.Row="0" />

        <!-- â­ CONTENU SCROLLABLE -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Style="{StaticResource MainContainer}" Spacing="15">

                <!-- ðŸ·ï¸ TITRE -->
                <Label Text="Ajouter une catÃ©gorie"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Primary}" />

                <!-- ðŸ”¤ Nom de la catÃ©gorie -->
                <Label Text="Nom de la catÃ©gorie"
                       Style="{StaticResource FormLabel}" />

                <Border Style="{StaticResource InputBorder}">
                    <Entry Placeholder="Ex : Alimentation"
                           Text="{Binding Name}" />
                </Border>

                <!-- ðŸ’° Budget -->
                <Label Text="Budget"
                       Style="{StaticResource FormLabel}" />

                <Border Style="{StaticResource InputBorder}">
                    <Picker ItemsSource="{Binding Budgets}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            SelectedItem="{Binding SelectedBudget, Mode=TwoWay}"
                            Title="SÃ©lectionner un budget" />
                </Border>

                <!-- ðŸŽ¨ Couleur -->
                <Label Text="Couleur"
                       Style="{StaticResource FormLabel}" />

                <CollectionView
                    ItemsSource="{Binding ColorOptions}"
                    SelectedItem="{Binding SelectedColor, Mode=TwoWay}"
                    SelectionMode="Single"
                    ItemsLayout="VerticalGrid,4"
                    Margin="0,10">

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid>

                                <!-- Cercle couleur -->
                                <Border
                                    WidthRequest="50"
                                    HeightRequest="50"
                                    StrokeThickness="2"
                                    Stroke="{Binding ., Converter={StaticResource SelectedColorToBorderConverter},
                                                      ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}"
                                    StrokeShape="Ellipse"
                                    BackgroundColor="{Binding .}"
                                    Margin="8">

                                    <Border.Triggers>

                                        <!-- ANIMATION SCALE -->
                                        <DataTrigger TargetType="Border"
                                                     Binding="{Binding ., Converter={StaticResource SelectedColorToBoolConverter},
                                                                          ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}"
                                                     Value="True">
                                            <Setter Property="Scale" Value="1.15"/>
                                        </DataTrigger>

                                        <DataTrigger TargetType="Border"
                                                     Binding="{Binding ., Converter={StaticResource SelectedColorToBoolConverter},
                                                                          ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}"
                                                     Value="False">
                                            <Setter Property="Scale" Value="1"/>
                                        </DataTrigger>

                                    </Border.Triggers>

                                    <!-- âœ” CHECKMARK -->
                                    <!--<Image Source="close_icon.png"
                                           WidthRequest="24"
                                           HeightRequest="24"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           Opacity="{Binding ., Converter={StaticResource SelectedColorToOpacityConverter},
                                                            ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}" />-->

                                </Border>

                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>


                <!-- ðŸ“Š RÃ©partition du budget (%) -->
                <Label Text="RÃ©partition du budget (%)"
                    Style="{StaticResource FormLabel}" />

                <Grid ColumnDefinitions="*,Auto"
                  RowDefinitions="Auto">

                    <Slider Minimum="0"
                        Maximum="100"
                        Value="{Binding Percentage, Mode=TwoWay}"
                        ThumbColor="{StaticResource Primary}"
                        MaximumTrackColor="{StaticResource Secondary}"
                        MinimumTrackColor="{StaticResource Primary}" />

                    <!-- Valeur (%) -->
                    <Label Grid.Column="1"
                       Text="{Binding Percentage, StringFormat='{0:F0}%'}"
                       VerticalOptions="Center"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Primary}" />

                </Grid>

                <!-- ðŸ’¶ Montant dynamique -->
                <Label Text="{Binding AmountPreview, StringFormat='Montant : {0:F2} â‚¬'}"
                       FontAttributes="Bold"
                        HorizontalOptions="End"
                       TextColor="{StaticResource Primary}" />  

                <!-- â­ BOUTON -->
                <Button Text="Ajouter la catÃ©gorie"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding AddCategoryCommand}" />
                <Button Text="Annuler"
                     BackgroundColor="{StaticResource Secondary}"
                     Style="{StaticResource PrimaryButton}"
                     Command="{Binding CancelCommand}" />

            </VerticalStackLayout>
        </ScrollView>

        <!-- â­ NAVBAR -->
        <components:Navbar Grid.Row="2" />

    </Grid>
</ContentPage>
