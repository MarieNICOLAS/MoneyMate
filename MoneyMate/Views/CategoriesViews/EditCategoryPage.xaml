<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:MoneyMate.Components"
             xmlns:viewmodels="clr-namespace:MoneyMate.ViewModels"
             x:Name="PageRoot"
             x:Class="MoneyMate.Views.EditCategoryPage">

    <!-- ViewModel -->
    <ContentPage.BindingContext>
        <viewmodels:CategoryViewModel />
    </ContentPage.BindingContext>

    <!-- STRUCTURE GLOBALE -->
    <Grid RowDefinitions="Auto,*,Auto"
          BackgroundColor="{StaticResource BackgroundLight}">

        <!-- â­ HEADER -->
        <components:HeaderAuthenticated Grid.Row="0" />

        <!-- â­ CONTENU SCROLLABLE -->
        <ScrollView Grid.Row="1" Padding="0,0,0,40">
            <VerticalStackLayout Style="{StaticResource MainContainer}"
                                 Spacing="15"
                                 Margin="0,0,0,80">

                <!-- ðŸ·ï¸ TITRE -->
                <Label Text="Modifier une catÃ©gorie"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Primary}" />

                <!-- ðŸ”¤ Nom -->
                <Label Text="Nom de la catÃ©gorie"
                       Style="{StaticResource FormLabel}" />

                <Border Style="{StaticResource InputBorder}">
                    <Entry Placeholder="Ex : Alimentation"
                           Text="{Binding Name}" />
                </Border>

                <!-- ðŸ’° Budget -->
                <Label Text="Budget"
                       Style="{StaticResource FormLabel}" />

                <Border Style="{StaticResource InputBorder}">
                    <Picker ItemsSource="{Binding Budgets}"
                            ItemDisplayBinding="{Binding DisplayName}"
                            SelectedItem="{Binding SelectedBudget, Mode=TwoWay}"
                            Title="SÃ©lectionner un budget" />
                </Border>

                <!-- ðŸŽ¨ Couleur -->
                <Label Text="Couleur"
                       Style="{StaticResource FormLabel}" />

                <CollectionView
                    ItemsSource="{Binding ColorOptions}"
                    SelectedItem="{Binding SelectedColor, Mode=TwoWay}"
                    SelectionMode="Single"
                    Margin="0,10">

                    <!-- GRILLE 4 COLONNES -->
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" Span="4" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <!-- Cercle couleur -->
                                <Border
                                    WidthRequest="50"
                                    HeightRequest="50"
                                    StrokeThickness="2"
                                    Stroke="{Binding ., Converter={StaticResource SelectedColorToBorderConverter},
                                                      ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}"
                                    StrokeShape="Ellipse"
                                    BackgroundColor="{Binding .}"
                                    Margin="8">

                                    <Border.Triggers>

                                        <!-- ANIMATION SELECT -->
                                        <DataTrigger TargetType="Border"
                                                     Binding="{Binding ., Converter={StaticResource SelectedColorToBoolConverter},
                                                                          ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}"
                                                     Value="True">
                                            <Setter Property="Scale" Value="1.15"/>
                                        </DataTrigger>

                                        <DataTrigger TargetType="Border"
                                                     Binding="{Binding ., Converter={StaticResource SelectedColorToBoolConverter},
                                                                          ConverterParameter={Binding BindingContext.SelectedColor, Source={x:Reference PageRoot}}}"
                                                     Value="False">
                                            <Setter Property="Scale" Value="1"/>
                                        </DataTrigger>

                                    </Border.Triggers>

                                </Border>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>

                <!-- ðŸ“Š RÃ©partition -->
                <Label Text="RÃ©partition du budget (%)"
                       Style="{StaticResource FormLabel}" />

                <Grid ColumnDefinitions="*,Auto"
                      RowDefinitions="Auto">

                    <Slider Minimum="0"
                            Maximum="100"
                            Value="{Binding Percentage, Mode=TwoWay}"
                            ThumbColor="{StaticResource Primary}"
                            MaximumTrackColor="{StaticResource Secondary}"
                            MinimumTrackColor="{StaticResource Primary}" />

                    <Label Grid.Column="1"
                           Text="{Binding Percentage, StringFormat='{0:F0}%'}"
                           VerticalOptions="Center"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}" />
                </Grid>

                <!-- ðŸ’¶ Montant dynamique -->
                <Label Text="{Binding AmountPreview, StringFormat='Montant : {0:F2} â‚¬'}"
                       FontAttributes="Bold"
                       HorizontalOptions="End"
                       TextColor="{StaticResource Primary}" />

                <!-- â­ BOUTONS -->
                <VerticalStackLayout Spacing="10">

                    <Button Text="Valider les modifications"
                            Style="{StaticResource PrimaryButton}"
                            Command="{Binding UpdateCategoryCommand}" />

                    <Button Text="Supprimer la catÃ©gorie"
                            BackgroundColor="{StaticResource Danger}"
                            Style="{StaticResource PrimaryButton}"
                            Command="{Binding DeleteCategoryCommand}" />

                    <Button Text="Annuler"
                            BackgroundColor="{StaticResource Secondary}"
                            Style="{StaticResource PrimaryButton}"
                            Command="{Binding CancelCommand}" />

                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <!-- â­ NAVBAR -->
        <components:Navbar Grid.Row="2" />

    </Grid>
</ContentPage>
